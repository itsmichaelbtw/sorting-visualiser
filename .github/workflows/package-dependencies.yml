name: Package Dependencies

on:
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

run-name: Package Dependencies

concurrency:
  group: ${{ github.event.repository.name }}
  cancel-in-progress: true

jobs:
  package-json-exists:
    name: Does "package.json" Exist?
    runs-on: ubuntu-latest
    outputs:
      package-json-exists: ${{ steps.exists.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check if "package.json" exists
        id: exists
        run: |
          if [ -f package.json ]; then
            echo "result=true" >> "$GITHUB_OUTPUT"
          else
            echo "result=false" >> "$GITHUB_OUTPUT"
          fi
        shell: bash

  update-package-dependencies:
    name: Update Package Dependencies
    runs-on: ubuntu-latest
    needs: package-json-exists
    if: needs.package-json-exists.outputs.package-json-exists == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Branch Name
        id: extract_branch
        run: echo "branch=${GITHUB_HED_REF:-${GITHUB_REF#refs/heads/}}" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Update Package Dependencies
        run: |
          npm install npm-check-updates -g
          npx ncu -u

      - name: Commit Changes
        run: |
          if [[ -n $(git status -s) ]]; then
            git checkout ${{ steps.extract_branch.outputs.branch }}

            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            git add .

            git commit -m "chore(deps): update package dependencies" -a

            git push --set-upstream origin ${{ steps.extract_branch.outputs.branch }}
          fi
